<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Audio Recorder</h1>
        <div class="text-center">
            <!-- Button to start and stop recording -->
            <button id="recordButton" class="btn btn-primary" style="font-size: 24px; padding: 20px;">
                Hold to Record
            </button>
        </div>
    </div>

    <script>
        // Accessing the user's microphone
        let mediaRecorder;
        let audioChunks = [];

        // Start recording when the button is pressed
        $('#recordButton').on('mousedown', function() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = function(event) {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = function() {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            const base64str = reader.result.split(',')[1];
                            sendAudioToServer(base64str);
                        };
                        reader.readAsDataURL(audioBlob);
                    };
                    mediaRecorder.start();
                })
                .catch(function(error) {
                    console.error('Error accessing microphone: ', error);
                });
        });

        // Stop recording when the button is released
        $('#recordButton').on('mouseup', function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        });

        // Send audio to server
        function sendAudioToServer(base64str) {
            $.ajax({
                url: '/fill_form',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 'audio': base64str }),
                success: function(response) {
                    playAudio(response.audio);
                    if (response.form_complete){
                        $("#recordButton").prop('disabled', true);
                    }
                },
                error: function(err) {
                    console.error('Error sending audio: ', err);
                }
            });
        }

        // Play the response audio
        function playAudio(base64str) {
            const audio = new Audio("data:audio/wav;base64," + base64str);
            audio.play();
        }
    </script>
</body>
</html>
